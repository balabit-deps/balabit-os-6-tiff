From 30c9234c7fd0dd5e8b1e83ad44370c875a0270ed Mon Sep 17 00:00:00 2001
From: erouault <erouault>
Date: Fri, 11 Nov 2016 20:22:01 +0000
Subject: [PATCH] * libtiff/tif_dirread.c: in TIFFFetchNormalTag(), make sure
 that values of tags with TIFF_SETGET_C16_ASCII / TIFF_SETGET_C32_ASCII access
 are null terminated, to avoid potential read outside buffer in
 _TIFFPrintField(). Fixes http://bugzilla.maptools.org/show_bug.cgi?id=2590

---
Index: tiff-4.0.6/libtiff/tif_dirread.c
===================================================================
--- tiff-4.0.6.orig/libtiff/tif_dirread.c	2017-02-24 10:16:39.103621363 -0500
+++ tiff-4.0.6/libtiff/tif_dirread.c	2017-02-24 10:16:39.103621363 -0500
@@ -4983,6 +4983,11 @@
 					if (err==TIFFReadDirEntryErrOk)
 					{
 						int m;
+                        if( dp->tdir_count > 0 && data[dp->tdir_count-1] != '\0' )
+                        {
+                            TIFFWarningExt(tif->tif_clientdata,module,"ASCII value for tag \"%s\" does not end in null byte. Forcing it to be null",fip->field_name);
+                            data[dp->tdir_count-1] = '\0';
+                        }
 						m=TIFFSetField(tif,dp->tdir_tag,(uint16)(dp->tdir_count),data);
 						if (data!=0)
 							_TIFFfree(data);
@@ -5155,6 +5160,11 @@
 				if (err==TIFFReadDirEntryErrOk)
 				{
 					int m;
+                    if( dp->tdir_count > 0 && data[dp->tdir_count-1] != '\0' )
+                    {
+                        TIFFWarningExt(tif->tif_clientdata,module,"ASCII value for tag \"%s\" does not end in null byte. Forcing it to be null",fip->field_name);
+                        data[dp->tdir_count-1] = '\0';
+                    }
 					m=TIFFSetField(tif,dp->tdir_tag,(uint32)(dp->tdir_count),data);
 					if (data!=0)
 						_TIFFfree(data);
