From d651abc097d91fac57f33b5f9447d0a9183f58e7 Mon Sep 17 00:00:00 2001
From: erouault <erouault>
Date: Wed, 9 Nov 2016 23:00:49 +0000
Subject: [PATCH] * libtiff/tif_strip.c: make TIFFNumberOfStrips() return the
 td->td_nstrips value when it is non-zero, instead of recomputing it. This is
 needed in TIFF_STRIPCHOP mode where td_nstrips is modified. Fixes a read
 outsize of array in tiffsplit (or other utilities using
 TIFFNumberOfStrips()). Fixes
 http://bugzilla.maptools.org/show_bug.cgi?id=2587

---
 ChangeLog           | 8 ++++++++
 libtiff/tif_strip.c | 9 +++++++++
 2 files changed, 17 insertions(+)

#diff --git a/ChangeLog b/ChangeLog
#index 48fb75d..4ff5281 100644
#--- a/ChangeLog
#+++ b/ChangeLog
#@@ -1,3 +1,11 @@
#+2016-11-10 Even Rouault <even.rouault at spatialys.com>
#+
#+	* libtiff/tif_strip.c: make TIFFNumberOfStrips() return the td->td_nstrips
#+	value when it is non-zero, instead of recomputing it. This is needed in
#+	TIFF_STRIPCHOP mode where td_nstrips is modified. Fixes a read outsize of
#+	array in tiffsplit (or other utilities using TIFFNumberOfStrips()).
#+	Fixes http://bugzilla.maptools.org/show_bug.cgi?id=2587
#+
# 2016-11-04 Even Rouault <even.rouault at spatialys.com>
# 
# 	* libtiff/tif_predic.c: fix memory leaks in error code paths added in
Index: tiff-4.0.6/libtiff/tif_strip.c
===================================================================
--- tiff-4.0.6.orig/libtiff/tif_strip.c	2017-02-24 10:39:18.892558676 -0500
+++ tiff-4.0.6/libtiff/tif_strip.c	2017-02-24 10:40:08.913181724 -0500
@@ -63,6 +63,15 @@
 	TIFFDirectory *td = &tif->tif_dir;
 	uint32 nstrips;
 
+	/* If the value was already computed and store in td_nstrips, then return it,
+	   since ChopUpSingleUncompressedStrip might have altered and resized the
+	   since the td_stripbytecount and td_stripoffset arrays to the new value
+	   after the initial affectation of td_nstrips = TIFFNumberOfStrips() in
+	   tif_dirread.c ~line 3612.
+	   See http://bugzilla.maptools.org/show_bug.cgi?id=2587 */
+	if( td->td_nstrips )
+		return td->td_nstrips;
+
 	nstrips = (td->td_rowsperstrip == (uint32) -1 ? 1 :
 	     TIFFhowmany_32(td->td_imagelength, td->td_rowsperstrip));
 	if (td->td_planarconfig == PLANARCONFIG_SEPARATE)
