From 2ea32f7372b65c24b2816f11c04bf59b5090d05b Mon Sep 17 00:00:00 2001
From: erouault <erouault>
Date: Thu, 12 Jan 2017 19:23:20 +0000
Subject: [PATCH] * libtiff/tif_ojpeg.c: fix leak in
 OJPEGReadHeaderInfoSecTablesQTable, OJPEGReadHeaderInfoSecTablesDcTable and
 OJPEGReadHeaderInfoSecTablesAcTable

---
 ChangeLog           | 3 ++-
 libtiff/tif_ojpeg.c | 6 ++++++
 2 files changed, 8 insertions(+), 1 deletion(-)

#diff --git a/ChangeLog b/ChangeLog
#index 12e0370b..cd2fa171 100644
#--- a/ChangeLog
#+++ b/ChangeLog
#@@ -1,6 +1,7 @@
# 2017-01-12 Even Rouault <even.rouault at spatialys.com>
# 
#-	* libtiff/tif_ojpeg.c: fix leak in OJPEGReadHeaderInfoSecTablesAcTable
#+	* libtiff/tif_ojpeg.c: fix leak in OJPEGReadHeaderInfoSecTablesQTable,
#+	OJPEGReadHeaderInfoSecTablesDcTable and OJPEGReadHeaderInfoSecTablesAcTable
# 	when read fails.
# 	Patch by Nicolás Peña.
# 	Fixes http://bugzilla.maptools.org/show_bug.cgi?id=2659
Index: tiff-4.0.6/libtiff/tif_ojpeg.c
===================================================================
--- tiff-4.0.6.orig/libtiff/tif_ojpeg.c	2018-03-20 07:45:40.320077358 -0400
+++ tiff-4.0.6/libtiff/tif_ojpeg.c	2018-03-20 07:45:40.320077358 -0400
@@ -1789,7 +1789,10 @@ OJPEGReadHeaderInfoSecTablesQTable(TIFF*
 			TIFFSeekFile(tif,sp->qtable_offset[m],SEEK_SET); 
 			p=TIFFReadFile(tif,&ob[sizeof(uint32)+5],64);
 			if (p!=64)
+                        {
+                                _TIFFfree(ob);
 				return(0);
+                        }
 			sp->qtable[m]=ob;
 			sp->sof_tq[m]=m;
 		}
@@ -1853,7 +1856,10 @@ OJPEGReadHeaderInfoSecTablesDcTable(TIFF
 				rb[sizeof(uint32)+5+n]=o[n];
 			p=TIFFReadFile(tif,&(rb[sizeof(uint32)+21]),q);
 			if (p!=q)
+                        {
+                                _TIFFfree(rb);
 				return(0);
+                        }
 			sp->dctable[m]=rb;
 			sp->sos_tda[m]=(m<<4);
 		}
