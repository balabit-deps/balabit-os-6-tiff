From fb3dc46a2fcf6197ff3b93fc76f0c37fddc0333b Mon Sep 17 00:00:00 2001
From: erouault <erouault>
Date: Thu, 27 Apr 2017 15:46:22 +0000
Subject: [PATCH] * libtiff/tif_dirread.c: fix memory leak in non
 DEFER_STRILE_LOAD mode (ie default) when there is both a StripOffsets and
 TileOffsets tag, or a StripByteCounts and TileByteCounts Fixes
 http://bugzilla.maptools.org/show_bug.cgi?id=2689 * tools/tiff2ps.c: call
 TIFFClose() in error code paths.

---
 ChangeLog             |  7 +++++++
 libtiff/tif_dirread.c | 18 +++++++++++++++++-
 tools/tiff2ps.c       |  6 ++++++
 3 files changed, 30 insertions(+), 1 deletion(-)

#diff --git a/ChangeLog b/ChangeLog
#index d5c1efca..11639b98 100644
#--- a/ChangeLog
#+++ b/ChangeLog
#@@ -1,3 +1,10 @@
#+2017-04-27
#+	* libtiff/tif_dirread.c: fix memory leak in non DEFER_STRILE_LOAD
#+	mode (ie default) when there is both a StripOffsets and
#+	TileOffsets tag, or a StripByteCounts and TileByteCounts
#+	Fixes http://bugzilla.maptools.org/show_bug.cgi?id=2689
#+	* tools/tiff2ps.c: call TIFFClose() in error code paths.
#+
# 2017-02-25 Even Rouault <even.rouault at spatialys.com>
# 
# 	* libtiff/tif_fax3.c, tif_predict.c, tif_getimage.c: fix GCC 7
Index: tiff-4.0.6/libtiff/tif_dirread.c
===================================================================
--- tiff-4.0.6.orig/libtiff/tif_dirread.c	2018-03-20 07:50:06.976383747 -0400
+++ tiff-4.0.6/libtiff/tif_dirread.c	2018-03-20 07:50:06.972383742 -0400
@@ -3733,6 +3733,14 @@ TIFFReadDirectory(TIFF* tif)
                                 _TIFFmemcpy( &(tif->tif_dir.td_stripoffset_entry),
                                              dp, sizeof(TIFFDirEntry) );
 #else                          
+                                if( tif->tif_dir.td_stripoffset != NULL )
+                                {
+                                    TIFFErrorExt(tif->tif_clientdata, module,
+                                        "tif->tif_dir.td_stripoffset is "
+                                        "already allocated. Likely duplicated "
+                                        "StripOffsets/TileOffsets tag");
+                                    goto bad;
+                                }
 				if (!TIFFFetchStripThing(tif,dp,tif->tif_dir.td_nstrips,&tif->tif_dir.td_stripoffset))  
 					goto bad;
 #endif                                
@@ -3743,7 +3751,15 @@ TIFFReadDirectory(TIFF* tif)
                                 _TIFFmemcpy( &(tif->tif_dir.td_stripbytecount_entry),
                                              dp, sizeof(TIFFDirEntry) );
 #else                          
-				if (!TIFFFetchStripThing(tif,dp,tif->tif_dir.td_nstrips,&tif->tif_dir.td_stripbytecount))  
+                                if( tif->tif_dir.td_stripbytecount != NULL )
+                                {
+                                    TIFFErrorExt(tif->tif_clientdata, module,
+                                        "tif->tif_dir.td_stripbytecount is "
+                                        "already allocated. Likely duplicated "
+                                        "StripByteCounts/TileByteCounts tag");
+                                    goto bad;
+                                }
+                                if (!TIFFFetchStripThing(tif,dp,tif->tif_dir.td_nstrips,&tif->tif_dir.td_stripbytecount))  
 					goto bad;
 #endif                                
 				break;
Index: tiff-4.0.6/tools/tiff2ps.c
===================================================================
--- tiff-4.0.6.orig/tools/tiff2ps.c	2018-03-20 07:50:06.976383747 -0400
+++ tiff-4.0.6/tools/tiff2ps.c	2018-03-20 07:50:06.972383742 -0400
@@ -466,10 +466,16 @@ main(int argc, char* argv[])
 		if (tif != NULL) {
 			if (dirnum != -1
                             && !TIFFSetDirectory(tif, (tdir_t)dirnum))
+                        {
+                                TIFFClose(tif);
 				return (-1);
+                        }
 			else if (diroff != 0 &&
 			    !TIFFSetSubDirectory(tif, diroff))
+                        {
+                                TIFFClose(tif);
 				return (-1);
+                        }
 			np = TIFF2PS(output, tif, pageWidth, pageHeight,
 				     leftmargin, bottommargin, centered);
                         if (np < 0)
