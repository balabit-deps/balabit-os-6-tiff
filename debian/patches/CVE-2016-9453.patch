From d2955714a4a0b8ca10941550cfbf64c7e111fbf1 Mon Sep 17 00:00:00 2001
From: erouault <erouault>
Date: Sat, 8 Oct 2016 15:14:42 +0000
Subject: [PATCH] * tools/tiff2pdf.c: fix read -largely- outsize of buffer in
 t2p_readwrite_pdf_image_tile(), causing crash, when reading a JPEG compressed
 image with TIFFTAG_JPEGTABLES length being one. Reported as MSVR 35101 by
 Axel Souchet and Vishal Chauhan from the MSRC Vulnerabilities & Mitigations
 team.

---
 ChangeLog        | 8 ++++++++
 tools/tiff2pdf.c | 4 ++--
 2 files changed, 10 insertions(+), 2 deletions(-)

#diff --git a/ChangeLog b/ChangeLog
#index 8f54f28..8b57d1b 100644
#--- a/ChangeLog
#+++ b/ChangeLog
#@@ -1,5 +1,13 @@
# 2016-10-08 Even Rouault <even.rouault at spatialys.com>
# 
#+	* tools/tiff2pdf.c: fix read -largely- outsize of buffer in
#+	t2p_readwrite_pdf_image_tile(), causing crash, when reading a
#+	JPEG compressed image with TIFFTAG_JPEGTABLES length being one.
#+	Reported as MSVR 35101 by Axel Souchet and Vishal Chauhan from
#+	the MSRC Vulnerabilities & Mitigations team.
#+
#+2016-10-08 Even Rouault <even.rouault at spatialys.com>
#+
# 	* tools/tiffcp.c: fix read of undefined variable in case of missing
# 	required tags. Found on test case of MSVR 35100.
# 	* tools/tiffcrop.c: fix read of undefined buffer in
Index: tiff-4.0.6/tools/tiff2pdf.c
===================================================================
--- tiff-4.0.6.orig/tools/tiff2pdf.c	2017-02-24 10:15:47.838982820 -0500
+++ tiff-4.0.6/tools/tiff2pdf.c	2017-02-24 10:15:47.834982770 -0500
@@ -2886,13 +2886,13 @@
 				return(0);
 			}
 			if(TIFFGetField(input, TIFFTAG_JPEGTABLES, &count, &jpt) != 0) {
-				if (count > 0) {
+				if (count >= 2) {
 					_TIFFmemcpy(buffer, jpt, count);
 					bufferoffset += count - 2;
 					table_end[0] = buffer[bufferoffset-2];
 					table_end[1] = buffer[bufferoffset-1];
 				}
-				if (count > 0) {
+				if (count >= 2) {
 					xuint32 = bufferoffset;
 					bufferoffset += TIFFReadRawTile(
 						input, 
