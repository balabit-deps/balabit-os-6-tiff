From 48780b4fcc425cddc4ef8ffdf536f96a0d1b313b Mon Sep 17 00:00:00 2001
From: erouault <erouault>
Date: Wed, 11 Jan 2017 16:38:26 +0000
Subject: [PATCH] =?UTF-8?q?*=20libtiff/tif=5Fgetimage.c:=20add=20explicit?=
 =?UTF-8?q?=20uint32=20cast=20in=20putagreytile=20to=20avoid=20UndefinedBe?=
 =?UTF-8?q?haviorSanitizer=20warning.=20Patch=20by=20Nicol=C3=A1s=20Pe?=
 =?UTF-8?q?=C3=B1a.=20Fixes=20http://bugzilla.maptools.org/show=5Fbug.cgi?=
 =?UTF-8?q?=3Fid=3D2658?=
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

---
 ChangeLog              | 7 +++++++
 libtiff/tif_getimage.c | 2 +-
 2 files changed, 8 insertions(+), 1 deletion(-)

#diff --git a/ChangeLog b/ChangeLog
#index 3e314644..6a342e5e 100644
#--- a/ChangeLog
#+++ b/ChangeLog
#@@ -1,3 +1,10 @@
#+2017-01-11 Even Rouault <even.rouault at spatialys.com>
#+
#+	* libtiff/tif_getimage.c: add explicit uint32 cast in putagreytile to
#+	avoid UndefinedBehaviorSanitizer warning.
#+	Patch by Nicolás Peña.
#+	Fixes http://bugzilla.maptools.org/show_bug.cgi?id=2658
#+
# 2017-01-11 Even Rouault <even.rouault at spatialys.com>
# 
# 	* libtiff/tif_read.c: avoid potential undefined behaviour on signed integer
Index: tiff-4.0.6/libtiff/tif_getimage.c
===================================================================
--- tiff-4.0.6.orig/libtiff/tif_getimage.c	2018-03-20 07:43:13.071825840 -0400
+++ tiff-4.0.6/libtiff/tif_getimage.c	2018-03-20 07:43:13.067825831 -0400
@@ -1286,7 +1286,7 @@ DECLAREContigPutFunc(putagreytile)
     while (h-- > 0) {
 	for (x = w; x-- > 0;)
         {
-            *cp++ = BWmap[*pp][0] & (*(pp+1) << 24 | ~A1);
+            *cp++ = BWmap[*pp][0] & ((uint32)*(pp+1) << 24 | ~A1);
             pp += samplesperpixel;
         }
 	cp += toskew;
