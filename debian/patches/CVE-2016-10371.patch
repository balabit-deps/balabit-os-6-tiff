From 0abd094b6e5079c4d8be733829240491cb230f3d Mon Sep 17 00:00:00 2001
From: erouault <erouault>
Date: Wed, 11 Jan 2017 12:51:59 +0000
Subject: [PATCH] * libtiff/tif_dirwrite.c: in
 TIFFWriteDirectoryTagCheckedRational, replace assertion by runtime check to
 error out if passed value is strictly negative. Fixes
 http://bugzilla.maptools.org/show_bug.cgi?id=2535

* tools/tiffcrop.c: remove extraneous TIFFClose() in error code path, that
caused double free.
Related to http://bugzilla.maptools.org/show_bug.cgi?id=2535
---
 ChangeLog              | 11 +++++++++++
 libtiff/tif_dirwrite.c |  9 +++++++--
 tools/tiffcrop.c       |  1 -
 3 files changed, 18 insertions(+), 3 deletions(-)

#diff --git a/ChangeLog b/ChangeLog
#index a7208f5e..6a752cd5 100644
#--- a/ChangeLog
#+++ b/ChangeLog
#@@ -1,3 +1,14 @@
#+2017-01-11 Even Rouault <even.rouault at spatialys.com>
#+
#+	* libtiff/tif_dirwrite.c: in TIFFWriteDirectoryTagCheckedRational, replace
#+	assertion by runtime check to error out if passed value is strictly
#+	negative.
#+	Fixes http://bugzilla.maptools.org/show_bug.cgi?id=2535
#+
#+	* tools/tiffcrop.c: remove extraneous TIFFClose() in error code path, that
#+	caused double free.
#+	Related to http://bugzilla.maptools.org/show_bug.cgi?id=2535
#+
# 2017-01-11 Even Rouault <even.rouault at spatialys.com>
# 
# 	* libtiff/tif_jpeg.c: avoid integer division by zero in
Index: tiff-4.0.6/libtiff/tif_dirwrite.c
===================================================================
--- tiff-4.0.6.orig/libtiff/tif_dirwrite.c	2018-03-20 07:42:32.767743413 -0400
+++ tiff-4.0.6/libtiff/tif_dirwrite.c	2018-03-20 07:42:32.763743404 -0400
@@ -2092,10 +2092,15 @@ TIFFWriteDirectoryTagCheckedSlong8Array(
 static int
 TIFFWriteDirectoryTagCheckedRational(TIFF* tif, uint32* ndir, TIFFDirEntry* dir, uint16 tag, double value)
 {
+        static const char module[] = "TIFFWriteDirectoryTagCheckedRational";
 	uint32 m[2];
-	assert(value>=0.0);
 	assert(sizeof(uint32)==4);
-	if (value<=0.0)
+        if( value < 0 )
+        {
+            TIFFErrorExt(tif->tif_clientdata,module,"Negative value is illegal");
+            return 0;
+        }
+	else if (value==0.0)
 	{
 		m[0]=0;
 		m[1]=1;
Index: tiff-4.0.6/tools/tiffcrop.c
===================================================================
--- tiff-4.0.6.orig/tools/tiffcrop.c	2018-03-20 07:42:32.767743413 -0400
+++ tiff-4.0.6/tools/tiffcrop.c	2018-03-20 07:42:32.763743404 -0400
@@ -7985,7 +7985,6 @@ writeCroppedImage(TIFF *in, TIFF *out, s
   if (!TIFFWriteDirectory(out))
     {
     TIFFError("","Failed to write IFD for page number %d", pagenum);
-    TIFFClose(out);
     return (-1);
     }
 
